<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
            <title>Pebble Auth Client</title>
    

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="../">
    <link rel="icon" href="images/favicon.ico"/>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/base.css">
            <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@100;200;300;400;600;700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="css/template.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/themes/prism-okaidia.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-numbers/prism-line-numbers.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-highlight/prism-line-highlight.css">
                <script src="https://cdn.jsdelivr.net/npm/fuse.js@3.4.6"></script>
        <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
        <script src="js/template.js"></script>
        <script src="js/search.js"></script>
        <script defer src="js/searchIndex.js"></script>
    </head>
<body id="top">
    <header class="phpdocumentor-header phpdocumentor-section">
    <h1 class="phpdocumentor-title"><a href="" class="phpdocumentor-title__link">Pebble Auth Client</a></h1>
    <input class="phpdocumentor-header__menu-button" type="checkbox" id="menu-button" name="menu-button" />
    <label class="phpdocumentor-header__menu-icon" for="menu-button">
        <i class="fas fa-bars"></i>
    </label>
    <section data-search-form class="phpdocumentor-search">
    <label>
        <span class="visually-hidden">Search for</span>
        <svg class="phpdocumentor-search__icon" width="21" height="20" viewBox="0 0 21 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="7.5" cy="7.5" r="6.5" stroke="currentColor" stroke-width="2"/>
            <line x1="12.4892" y1="12.2727" x2="19.1559" y2="18.9393" stroke="currentColor" stroke-width="3"/>
        </svg>
        <input type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading .." disabled />
    </label>
</section>

    <nav class="phpdocumentor-topnav">
    <ul class="phpdocumentor-topnav__menu">
        </ul>
</nav>
</header>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <input class="phpdocumentor-sidebar__menu-button" type="checkbox" id="sidebar-button" name="sidebar-button" />
<label class="phpdocumentor-sidebar__menu-icon" for="sidebar-button">
    Menu
</label>
<aside class="phpdocumentor-column -three phpdocumentor-sidebar">
                    <section class="phpdocumentor-sidebar__category">
            <h2 class="phpdocumentor-sidebar__category-header">guide</h2>
                                    <h4 class="phpdocumentor-sidebar__root-namespace">
    <a href="guide/quickstart.html#quickstart" class="">Quickstart</a>
</h4>

                        </section>
                <section class="phpdocumentor-sidebar__category">
            <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                    <h4 class="phpdocumentor-sidebar__root-namespace">
    <a href="namespaces/pebbleauthclient.html" class="">PebbleAuthClient</a>
</h4>
    <ul class="phpdocumentor-list">
                    <li>
                <a href="namespaces/pebbleauthclient-datatypes.html" class="">Datatypes</a>
                
            </li>
                    <li>
                <a href="namespaces/pebbleauthclient-interfaces.html" class="">Interfaces</a>
                
            </li>
                    <li>
                <a href="namespaces/pebbleauthclient-models.html" class="">Models</a>
                
            </li>
                    <li>
                <a href="namespaces/pebbleauthclient-services.html" class="">Services</a>
                
            </li>
            </ul>

                        </section>
                <section class="phpdocumentor-sidebar__category">
            <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                                    <h4 class="phpdocumentor-sidebar__root-namespace">
    <a href="packages/Application.html" class="">Application</a>
</h4>

                        </section>
            
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="indices/files.html">Files</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -nine phpdocumentor-content">
                                        <div class="section" id="quickstart">
    <h1>Quickstart</h1>

            <div class="section" id="introduction">
    <h2>Introduction</h2>

            <p>This library offer a client for authenticate user and licence management written in PHP compatible with many PHP API
Resource Server.</p>
    </div>

            <div class="section" id="installation">
    <h2>Installation</h2>

            <div class="section" id="requirements">
    <h3>Requirements</h3>

            <p>The following procedures explains the installation of the following packages :</p>
            

<ul>
    <li class="dash">PHP 8 or higher</li>

    <li class="dash">composer</li>

</ul>

    </div>

            <div class="section" id="install-with-composer">
    <h3>Install with composer</h3>

            <p>If your project use composer, simply add the following.</p>
            <pre><code class="language-">composer require pebble-solutions/pebbleauthclient
</code></pre>
    </div>

    </div>

            <div class="section" id="usage">
    <h2>Usage</h2>

            <div class="section" id="configuration">
    <h3>Configuration</h3>

            <p>Before you can work with the library, you must define a system environment variable with the URI of the public Json Web
Key Set (remote JWKS file).</p>
            <p>This file will be requested and store <strong>temporary</strong> on your API Server. Your server should be able to write on
<em>./var/credentials/auth/jwks.json</em> . If the file does not exist, it will be created.</p>
            <p><strong>If you start your server directly from a terminal, run this command on your terminal before starting your server :</strong></p>
            <pre><code class="language-">export PBL_JWKS_REMOTE_URI=https://SERVER_URI/path/jwks.json
</code></pre>
            <p><strong>If you start your server within a Docker container, you should add this line to your Dockefile :</strong></p>
            <pre><code class="language-Dockerfile">ENV PBL_JWKS_REMOTE_URI=https://SERVER_URI/path/jwks.json</code></pre>
            <p><strong>Other configurations</strong></p>
            <p>You can add more configuration by defining some more environment variables on your
system. These configurations have values by default that works for most of the cases.</p>
            .. list-table:: 



<ul>
    <li>

<ul>
    <li class="dash">Environment variable</li>

    <li class="dash">Default</li>

    <li class="dash">Description</li>

</ul>
</li>

    <li>

<ul>
    <li class="dash"><code>PBL_JWKS_REMOTE_URI</code></li>

    <li class="dash"><em>Unset</em></li>

    <li class="dash"><strong>MANDATORY</strong> URI of the remote jwks.json file. This file contains all active public keys to decode token.</li>

</ul>
</li>

    <li>

<ul>
    <li class="dash"><code>PBL_CERTS_FOLDER</code></li>

    <li class="dash">./var/credentials/auth</li>

    <li class="dash">Local folder for temporary store authentication credentials. Storing locally the credentials improves server response.</li>

</ul>
</li>

    <li>

<ul>
    <li class="dash"><code>PBL_JWKS_EXP_TIME</code></li>

    <li class="dash">86400</li>

    <li class="dash">Duration in seconds after which Keys Set (JWKS) is considered as expired. All local copy of the keys must be destroyed and the remote server will be requested to create the new copy.</li>

</ul>
</li>

</ul>

    </div>

            <div class="section" id="test-keys-pair">
    <h3>Test keys pair</h3>

            <div class="phpdocumentor-admonition attention">
                        <article>
        <p>These key files are not secured and must be used FOR TESTING PURPOSE ONLY on a local development environment !</p>
    </article>
</div>

            <p><strong>JWKS URI (for PBL_JWKS_REMOTE_URI environment variable)</strong></p>
            <p><a href="https://storage.googleapis.com/pebble-public-cdn/test_auth/jwks_test.json">https://storage.googleapis.com/pebble-public-cdn/test_auth/jwks_test.json</a></p>
            <p><strong>Public and private keys used to sign a token</strong></p>
            <p><a href="https://storage.googleapis.com/pebble-public-cdn/test_auth/public_test.pem">https://storage.googleapis.com/pebble-public-cdn/test_auth/public_test.pem</a></p>
            <p><a href="https://storage.googleapis.com/pebble-public-cdn/test_auth/private_test.pem">https://storage.googleapis.com/pebble-public-cdn/test_auth/private_test.pem</a></p>
    </div>

            <div class="section" id="authenticate-with-token-string">
    <h3>Authenticate with token string</h3>

            <pre><code class="language-PHP">$authService = new \PebbleAuthClient\Services\auth();

try {
    $pebbleAuthToken = $authService-&gt;auth(&quot;a.valid.token&quot;);
    $user = $pebbleAuthToken-&gt;getUser();
    $licence = $pebbleAuthToken-&gt;getAuthenticatedLicence();

    var_dump($pebbleAuthToken);
    var_dump($user);
    var_dump($licence);
}
catch (Exception $e) {
    echo &quot;Error : &quot;.$e-&gt;getMessage();
}</code></pre>
    </div>

            <div class="section" id="authenticate-with-http-authorization-header">
    <h3>Authenticate with HTTP Authorization header</h3>

            <div class="phpdocumentor-admonition note">
            <svg class="phpdocumentor-admonition__icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg>
                    <article>
        <p>This example shows one way to serverside authenticate a user with the Authorization header. The important thing is
to communicate an array to <code>authFromHttpHeaders()</code> function with a valid Authorization key value.</p>
    </article>
</div>

            <pre><code class="language-PHP">/**
 * This class is an example of a custom authenticator for symfony.
 */
class TokenAuthenticator extends AbstractAuthenticator
{
    /** ... */

    public function authenticate(Request $request): Passport
    {
        $authService = new \PebbleAuthClient\Services\auth();

        try {
            $pebbleAuthToken = $authService-&gt;authFromHttpHeaders($request-&gt;headers-&gt;all());
            $user = $pebbleAuthToken-&gt;getUser();
            $licence = $pebbleAuthToken-&gt;getAuthenticatedLicence();

            var_dump($pebbleAuthToken);
            var_dump($user);
            var_dump($licence);
        }
        catch (Exception $e) {
            throw $e;
        }

        // implement your own logic to get the user identifier
        $userIdentifier = /** ... */;

        return new SelfValidatingPassport(new UserBadge($userIdentifier));
    }

    /** ... */
}</code></pre>
    </div>

            <div class="section" id="check-the-audience">
    <h3>Check the audience</h3>

            <p>Audience identifies the recipients that the token is intended for. Each resource server MUST be identified by its
audience name and the authorization process MUST check that this audience exists in the token.</p>
            <div class="phpdocumentor-admonition warning">
                <svg class="phpdocumentor-admonition__icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <article>
        <p>By default, audience is not checked by the authentication process. It is the responsibility of the resource server
to communicate its audience name in order to only accept token that has been generated for the this specific
resource server.</p>
    </article>
</div>

            <p>To check the audience, add an <code>$options</code> array to the <code>auth()</code> or <code>authFromHttpHeaders()</code> functions.</p>
            <pre><code class="language-PHP">$authService = new \PebbleAuthClient\Services\auth();

// Check that the provided token has a valid audience for api.pebble.solutions/v5/my-resource
$auth_token = $authService-&gt;auth(&quot;----my.valid.token----&quot;, [
    &#039;audience&#039; =&gt; &quot;api.pebble.solutions/v5/my-resource&quot;
]);

// Check that token communicate through authorization header has a valid audience
// for api.pebble.solutions/v5/my-resource
$auth_token = $authService-&gt;authFromHttpHeaders(headers, [
    &#039;audience&#039; =&gt; &quot;api.pebble.solutions/v5/my-resource&quot;
]);</code></pre>
    </div>

    </div>

    </div>

                            </div>
            <section data-search-results class="phpdocumentor-search-results phpdocumentor-search-results--hidden">
    <section class="phpdocumentor-search-results__dialog">
        <header class="phpdocumentor-search-results__header">
            <h2 class="phpdocumentor-search-results__title">Search results</h2>
            <button class="phpdocumentor-search-results__close"><i class="fas fa-times"></i></button>
        </header>
        <section class="phpdocumentor-search-results__body">
            <ul class="phpdocumentor-search-results__entries"></ul>
        </section>
    </section>
</section>
        </div>
        <a href="guide/quickstart.html#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <script>
        cssVars({});
    </script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-highlight/prism-line-highlight.min.js"></script>
</body>
</html>
